## 自我介绍

> 面试官您好,我叫 xxx,20xx 年毕业于 xx 大学,至今有 x 年的前端开发经验,之前工作中自已主要参与开发过 pc 端 toB 业务`星云平台`,移动端 h5 业务`齐鲁银行智慧APP6.0`,
> 自己使用的技术栈主要是 vue,vue2/3 都有过使用,对底层源码也有过相关的了解,使用 UI 框架有 Element,antd,可视化图表库使用过 Echarts,d3.js
> 自己工作之余喜欢看一些大佬的书籍和博客,比如`阮一峰老师周刊和开发者手册`,`掘金黄轶老师的 vue 的源码讲解`,
> 也经常去`B站`和`极客时间`学习自己感兴趣前端技术
> 我的自我介绍完毕了,谢谢面试官

## 项目难点

### 星云平台

1. 流水线打包部署(重点: 打包优化)

- 前端通常打包,是通过`npm run build`生成 dist 目录,压缩通过`xftp 或 xshell`上传到服务器发布,但对于有还有规范检验的,在多个环境频繁打包的就显得麻烦了,所以通过流水线部署,通过关联代码仓库,设定门禁系统(全量和增量),可信规范(codecheck 检测),安全测试,多个环境一站式部署,可以设置定时发布,生成质量报告

- 打包优化
  1. 通过`npm run build --report`导出`report.html`打包分析文件
  2. `externals`,大的不打包'vue echarts vue-router axios',使用内部 CDN 引入
  3. 使用`split-chunks`,提取重复代码,动态导入,按需加载`babel-plugin-component`
  4. 使用`thread-loader`多线程打包`terser-webpack-plugin`,主要针对`babel eslint`的 js

2. 日志文件过大(文件上传)

- Blob.prototype.slice,并发多个,记录顺序
- 封闭 xhr,返回 Promise
- 切片 10M,放入 formData 中,使用 Promise.all 并发上传
- 进度条
  1. 单个切片上传进度,整个文件上传进度
  2. 监听 upload.onprogress,工厂函数,返回不同的监听函数
  3. 总进度条,单个切片累计/整个文件大小,使用 vue 的计算属性
- 断点续传
  1. 内容生成 hash,库`spark-md5`,文件过大,`UI阻塞,页面假死`,使用`web worker`解决,`postMessage`发送进度
  2. 暂停:xhr 对象保存成`requestList`,上传成功删除,调用`abort`方法,取消请求
  3. 恢复上传:调用接口,返回已传的切片,跳过切片,filter 过滤
- 文件秒传
  1. 上传前,计算出 hash,发给服务端,找到,返回成功
- Bug 处理
  1. 点击暂停清空 xhr 请求,点击恢复,重新创建了 xhr 导总进度条`倒退`
  2. `假进度条`,基于总文件进度条,只会`停止和增加`
  3. `vue监听属性`,真的增加也`增加`,真的的减少就`暂停`

3. Echarts 不更新

- resize()
- 'transiton' 'transitionstart' 和 'transitionend'
- 'setInterval'
- 窗口不会触发,依然需要监听 'window.resize'
- DOM 属性和节点变化检测`Mutation Observer`,DOM 尺寸变化`ResizeObserver`

```
const ro = new ResizeObserver(cb)
ro.observer(el)
```

- 返回一个`contentRect`

4. vue 升级 vue3 Table 加载变慢

- vue3 性能优化减少了`85%`渲染耗时(6.88s 减少到 1s)
  1. 工作中要把一处重要模块从 vue2 升级到 vue3,升级后发现 element-plus 性能相比于 vue2 严重下降
  2. 表格是`50行*300列的`,自定义两列一列选择框,一列开关,在切换开关时,`600-700ms下降到5-6s`,严重影响用户体验
- 优化内容
- 修改 table 源码,将 data 与 columns 从 ref 改为`shallowRef`(性能减少了 17%-20%)
  1. 当时发现这个问题后,我们先去看了 table 的源码,发现传入的 table 参数`data 与 columns`都是使用 ref 进行响应式转换的
  2. 这边又去查阅了 vue3 官方文档,发现说的一个对象赋值给 ref,这个对象通过`reactive`转为`深层次响应式的对象`,包含了嵌套的 ref,深层的解包,性能消耗是比较大的,要避免`深层次的转换`使用`shallowRef`
  3. `shallowRef`是`浅层次作用`,仅当`xx.value`变更时,才触发更新,`减少深层次依赖,提升patch对比性能`
  4. 副作用,修改之后会不会对之前的功能有影响
  - 我们每次列表数据更新,业务逻辑都会去请求列表设置`list.value===xxx`是可以正常触发 shallowRef 更新的
  - 经过我们测试,switch 开关`v-model绑定的scope.row.status`变更也是正常的
  - 手动点击`选中,排序,分页`都没有影响
  - 当然,这种修改肯定不影响之前的业务前提下修改,修改之后,要多加测试,对之前有影响,就要换种方法
- 源码中`getColspanRealWidth`函数响应式数据优化(性能提高 7%-20%,函数耗时 200ms 下降到 7ms)
  1. 当页面卡顿时,我们通过 devtool 的`performance面板`测试性能,我们录制一个`switch开关切换`性能数据,发现在 main 中的有两个带红色`longtask`长任务,1.89+1.73,整体耗时 3.5s 左右,我们点击观察对应的`火焰图`,发现紫色小块`Render`比较耗时,点击 render,在底部详情里面通过`bottom-up`和`call tree`中,发现一个函数`getColspanRealWidth`耗时 200ms 比较严重,通过右侧的`source map`跳到对应源码进行分析
  2. 发现,函数依赖的参数是响应式的,我们对这个参数通过一个函数返回,处理为`非响应式的`,修改为测试,函数耗时从`200ms到1ms`,render 性能提升
- 代码业务逻辑进行优化(2.7s 到 0.5s)
  1. 经过上面的优化后,意识到,`很细微的呚式数据优化也会对性能带来较大的影响`,这同样适用于业务逻辑中
  2. 采用注释加替换静态节点的方法,找到具体哪里耗时,然后针对优化
  3. 自定义列中`el-tooltip`换成静态节点后,性能有大的提升.有 performance 面板看到 patch 基本没有了,编译成静态节点,更新不用对比了
  4. 基于这个思路,el-tooltip 组件会成倍的增加 patch 比对耗时,那我们减少它的数量就能提高性能
  5. 原本之前业务 el-tooltop 使用了 disabled 属性用于隐藏 tooltop,但元素还是会渲染,我们修改为`v-if`,减少了元素渲染,测试发现达到 0.5s 刷新
- 通过这次优化,自己也学到了很多东西
  1. 在分析性能时,自己要多借用 performance 面板工具对应录制分析,自己也可以写一个性能耗时逻辑做对比,有数据参数.对组件的耗时,可以借助 vue-devtool 查看组件更新渲染耗时,排查响应式数据问题
  2. 业务场景代码时,自己要采用`注释+静态节点替换`排查耗时比较长的逻辑,针对性优化
- 反问: 不使用虚拟列表
  1. 虚拟列表不够丝滑,不支持横向滚动,我们的 table 做了顶部固定,和底部滚动优化,里面改动非常大轻易替换非常麻烦,所以花了长时间优化

5. 两栏布局, 拖动过快出现卡顿 和 失效

6. 事件对筛选

### h5 智慧 APP6.0

1. 封装组件过程(金额输入控件)

- 属性
  - type 组件类型(rmb,美元)
  - clientKeybord 是否调用客户端键盘 (系统键盘,自带键盘)
  - dataRoleRegex 验证规则
  - dataRoleRegexMsg 错误提示 (不符合规则进行提示)
  - placeholder 占位符
  - maxlength 最大长度
  - clear 是否清除图标显示
  - disabled 是否禁用
  - readonly 是否只读
  - name 表单绑定的值
  - digits 保留小数后多少位
- 事件
  - change 输入值变化
  - focus 聚焦
  - blur 失焦

2. 超过 2000 条卡顿(虚拟列表)

- 时间分片
  1. 卡顿是同时渲染大量 DOM 引起的,将渲染过程分批进行
  2. 使用 `setTimeout 分段加载`,加载速度提升了,快速滚动时出现`白屏和闪屏`
     - `闪屏原因:`
     - 执行时间不确定,宏任务的,主线程执行完了,才会执行它,实际执行时间会比设定的慢
     - fps 受屏幕分辨率和屏幕尺寸影响,不同设备刷新频率可能不同,setTimeout 只能设置固定时间
     - 对 dom 操作,必须等到屏幕下次绘制,`两者步调不一致,导致某一帧跨过去,直接更新下一帧,导致丢帧`
  3. 使用`requestAnimationFrame` 和 `DocumentFragment`
     - 由系统决定回调函数执行机制,`屏幕每一次刷新间隔只执行一次,滚动流畅不会闪烁丢帧`
     - 内存中 dom,插入时不会引起页面回流,append 时只插入子元素不带本身
     - 只针对大量简单 dom 插入,我们账单列表比较复杂,插入时性能表现还是不够理想
- 长列表渲染

  1. performance 分析消耗时间最多是`Recalculate style 样式计算`和`Layout布局`
  2. 只加载`可视区域`的列表项,滚动时动态计算获取`可视区域`,把`非可视区域`列表删除

  ```
    // html
    <div class="viewport">
      <div class="bar"></div>
      <div class="list"></div>
    </div>

    1. 视口相对定位,list相对定位
    2. 计算出视口,能加载的列表数量
    3. 通过视口scrollTop / 账单列表高度,计算属性动态初始和终止,list.slice()获得需要加载的数据
    4. 发现,相对定位也会发生上移,通过list.transform设置translateY滚动条顶部的高度,平移下来
    5. 实现 长列表滚动


  ```

  3. 监听`scroll事件`会频繁触发,造成`重复计算`,使用`intersectionObserver`替换,出现可视区域才会`异步触发对应回调函数`性能消耗极低

- 经过测试,在旧的手机上 iphone4s 运行也比较流畅,没有出现卡顿闪屏现象

3. ios video 标签时间轴不显示

4. 金币抛洒效果

- 存钱罐刚开始页面是静态的,产品经理让加动画,自己想了两种方案
  1. 使用 gif
     - 第一种使用 gif 动图,默认给一张静态图,当用户下滑到存钱罐时,用动态图替换,动效完毕后,再把图片用静态图替换掉来实现
     - 存在 2 个问题,1 是首先切换图片时,会出现`闪屏`,当时通过定时器,延时解决了
     - 2 是,gif 图片是循环播放的,在页面第一次动画时,是正常的,当第二次时,就出现动画错乱了,最后查找原因,发现首次加载图片后,浏览器会缓存图片,下次切换时,由于是从缓存中拿到的,图片一直循环动画,第二次动画开始的时间就不确定了,形成了错乱,最后把图片元素删除再重新 append,解决了这个问题
     - 最后,每次要删除图片,再 append,不能利用浏览器缓存,浪费性能,最后,决定自己实现动画
  2. 使用 animation 动画
     - 定时器 + Math.sin + cos (正弦 余弦),设置 bottom left 坐标
     - animation-timing-function steps 函数 起点和终点(简单,帧数少效果不流畅)
     - 取抛物线坐标上点, 效果流畅(算坐标比较麻烦)
     - 贝塞尔曲线

5. 折叠屏手机布局错乱

- 宽度问题
  1. 宝贝任务页面由于页面采用 flex+rem 布局,我们开发时,是以 750px 为标准开发的,把根元素的 font-size 设置为 50px,就是 15 份
  2. 在折叠屏展开时,整个页面变宽,采用 flex 布局,主轴设置为`space-bettween`,和剩余空间变行感觉大,看起来丑陋
  3. 我们通过设置`媒体查询`,当屏幕宽度大于 960 时,我们就把 font-size 固定为 50px,意思屏幕最大支持 960px,实现居中
- 高度问题(橡皮筋问题)
  1. 宝贝任务页面,要下滑到存钱罐,但在 ios 会存`橡皮筋效果`,整个 app 顶部都会跟着下滑,当时通过查找资料,发现要禁用`touchmove`事件
  2. 但是,高度是超出屏幕高度的,底部的账户信息需要下滑才能看到,由于禁止了,所以不能滑动,导致信息不能完全显示
  3. 在普通手机,经过高度发现`宽/高`比例是大于 1.5 时,整个屏幕信息可以显示完整,但折叠屏手机的宽高比例小于 1,因为是以宽度划分为 15 份,于是通过计算小于 1.5 时,就把高度平分 15 份作为根元素的 font-size,当离开宝贝任务页面时,再恢复过来就解决了

6. 首屏优化过程

### 代码性能分析

1. 前端规范制定

2. 轮询获得最新的分析结果,效率低下

3. monaco-editor 打包体积优化

- 先总体再优化
  - 打包后的 monaoc-editor 体积占一半,严重影响加载速度
  - 业务层面,只用到展示功能,语言编辑功能完全用不到,
  - 默认是支持所有语言的,我们只要五种主流语言,这些都要去掉,使用`monaco-editor-webpack-plugin`,按需引入需要的语言包
  - 重量级的,通过 webpack 的 splitChunks 功能拆分为单独文件,充分利用浏览器缓存
  - 加载,需要`代码高度`页面才需要加载
  - 开启`prefetch`预加载,在浏览器空闲时预先下载资源
- 先简单再叠加
  - 提供了`editor.api`引入,最基础的版本,没有`高亮,代码提示,折叠,右键`功能
  - 再分别引入对应包`主要语言,高亮,代码提示,折叠和代码格式化,代码联想`功能

4. 代码错误收集和上报

- 区分错误类型:`接口异常` 和 `代码逻辑异常`
- 接口异常
  1. 请求失败;获取响应,错误状态,在 axios 拦截器中统一处理
- 代码逻辑异常
  1. 逻辑错误,js 语法造成,vue 提供了`app.config.errorHandler`
  2. 错误对象,触发错误组件,错误的信息(生命周期钩子)
